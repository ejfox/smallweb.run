---
title: Smallweb 0.15 -
author: Achille Lacoin
tags:
    - release
draft: true
---

Hey there! I'm happy to announce the release of Smallweb `0.15`.

I must admit I spent quite a bit of time on this one, and I ended up scrapping a lot of the work I did. I initially wanted to build a tunneling solution for smallweb based on wireguard, before realizing that it was not the right approach.

Instead, I plan to focus on [Smallweb Cloud](https://cloud.smallweb.run/readme). Feel free to join the waitlist at [https://cloud.smallweb.run](https://cloud.smallweb.run).

## TLDR

- you should move your smallweb config from `~/.config/smallweb/config.json` to `$SMALLWEB_DIR/.smallweb/config.json`
- the global env variables are now set in `$SMALLWEB_DIR/.env`, and not in the smallweb config
- you now need to add a `--cron` flag to the `smallweb up` command to run the crons

## Smallweb directory as the source of truth

I talked about my previous smallweb setup in [a previous post](./2024-10-02_my_smallweb_setup.md). In this setup, smallweb is deployed on a VPS, and I sync the app to my local machine using [mutagen](https://mutagen.io/).

Even though this setup worked quite well, I found it to be a bit cumbersome. The main issue I had was that I had to connect to the VPS each time I wanted to run an app cli entrypoint with the `smallweb run` command.

It always felt a bit weird to me. If the smallweb dir is synced to my local machine using [mutagen](https://mutagen.io), why can't I run the cli entrypoints locally?

Starting from this version, most smallweb commands will work on both end if the smallweb dir is synced to your local machine:

- `smallweb open` can be use to open an app url in your browser, even if the app is running on a remote server
- `smallweb run [app]` can be used wherever your are, as long as the smallweb dir is synced to your local machine

## Revamped authentication

In the previous version of smallweb, I introduced a `private` field in the app config. This field was used to protect the app behind an authentication layer.

I realized that this was not the right approach. Auth requirements are often more complex, and using a static field in the app config was not enough.

Moreover, this means that the auth logic could not be used outside of smallweb, when I want most smallweb app to be able to run through `deno serve`.

So instead of using a `private` field in your app config, you should now directly wrap you app in the `lastlogin` middleware:

```ts
import { lastlogin } from "jsr:@pomdtr/lastlogin"

const handleRequest = async (req: Request) => {
    return new Response("Hello, world!")
}

export default {
    fetch: lastlogin(handleRequest, {
        verifyEmail: (email) => {
            return email === Deno.env.get("EMAIL")
        }
    })
}
```

Here, you can inject your own logic to verify the email of the user:

- use a `users` table from an sqlite database
- use a global `EMAIL` env variable
- allow anyone to signup
- ...

## Easier Admin Apps

Smallweb now has a concept of admin apps. Admin apps are apps that have read/write access to the whole smallweb dir.

Since the whole smallweb state is available from the smallweb dir, they can be used to:

- create a web IDE
- distribute a webdav server for your smallweb dir
- build an admin dashboard

To declare a new one, you can use the `admin` field in the app config:

```json
{
    "admin": true
}
```

This changes allowed me to repackage the existing api to run entirely in user space. You can host your own using the `jsr:@smallweb/api` package:

```ts
import { bearerAuth } from "jsr:@pomdtr/bearer-auth@0.1.0";
import { api } from "./mod.ts";

const app = api();

export default {
    fetch: bearerAuth(app.fetch, {
        verifyToken: (token: string) => {
            return token === Deno.env.get("API_TOKEN");
        },
        publicRoutes: ["/", "/openapi.json"],
    }),
};
```

I plan to also port the webdav server to it's own deno package using this new approach.

## Global `.env` file

Instead of configuring the global environments variable from the smallweb config, you should now use a `.env` file at the root of the smallweb dir.

```sh
# ~/smallweb/.env
MY_SECRET=123
```

## `open` function for cli entrypoints

Cli entrypoints used to share the same restrictions as the rest of the app. However, having the ability to open a url in the user's browser is quite necessary for cli entrypoints.

You can now easily achieve it by using the `open` function from the `@smallweb/open` package:

```ts
import { open } from "@smallweb/open";

export default {
    async run() {
        // open can only used from the `run` method
        await open("https://smallweb.run");
    }
}
```

## Update to crons

Since smallweb can now run from multiple servers, you now need to specify which server should trigger the crons.

You can do this by adding the `--cron` flag to the `smallweb up` command:

```sh
# run both the http server and the crons
smallweb up --cron
```

Or, if you want to dedicate a server to crons, you can use the `smallweb cron up` command:

```sh
# run only the crons
smallweb cron up
```

## Update to `smallweb logs`

Logs are now saved to `$XDG_CACHE_DIR/smallweb/logs`. You can view them as they are generated using the `smallweb logs` command:

```sh
smallweb logs
```

The smallweb logs will only show the logs from the smallweb instance the command is run from. If you want to see the logs from another instance, you can pair it with the ssh command:

```sh
ssh <remote-server> smallweb logs
```

## What's next?

### Web IDE

Now that I have found a neat model for admin apps, I plan to create a vscode integration entirely in userspace!

I'm taking inspiration from `https://membrane.io` here, please check them out if you haven't already.

### Smallweb Cloud

Owning your own VPS, or buying your own domain should not be a requirement to run smallweb apps.

I want smallweb to be accessible to everyone, so I'm planning
